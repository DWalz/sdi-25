<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Exercise 13 - Software Defined Infrastructure Group 2</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Exercise 13";
        var mkdocs_page_input_path = "exercise13.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Software Defined Infrastructure Group 2
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Manual Server Management</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise01/">Exercise 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise02/">Exercise 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise03/">Exercise 3</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise04/">Exercise 4</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise05/">Exercise 5</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise06/">Exercise 6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise07/">Exercise 7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise08/">Exercise 8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise09/">Exercise 9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise10/">Exercise 10</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cloud Provider</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../exercise11/">Exercise 11</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise12/">Exercise 12</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Exercise 13</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#securing-ssh-login">Securing SSH login</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#installing-fail2ban-plocate">Installing fail2ban &amp; plocate</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#firewall-attachment-issues">Firewall Attachment Issues</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise14/">Exercise 14</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise15/">Exercise 15</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise16/">Exercise 16</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise17/">Exercise 17</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise18/">Exercise 18</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise19/">Exercise 19</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise20/">Exercise 20</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise21/">Exercise 21</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise22/">Exercise 22</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise23/">Exercise 23</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise24/">Exercise 24</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Software Defined Infrastructure Group 2</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Cloud Provider</li>
      <li class="breadcrumb-item active">Exercise 13</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="exercise-13-working-on-cloud-init">Exercise 13: Working on Cloud-init</h1>
<blockquote>
<p>Click <a href="https://github.com/DWalz/sdi-25/tree/main/exercise13">here</a> to view the solution in the repository.</p>
</blockquote>
<p>Now instead of using a shell script to install and initialize <code>nginx</code>,
<a href="https://cloudinit.readthedocs.io/en/latest/index.html"><code>cloud-init</code></a> is used. Similarly to how Terraform is providing the
capabilities to describe an architecture as code and let terraform
handle the setup process, <code>cloud-init</code> provides the capabilites to
describe the server state as code and setup the sever respectively. The
following <code>cloud-init</code> configuration is used to install and enable
<code>nginx</code> as well as provide a custom landing page:</p>
<pre class="highlight"><code class="language-yml">#cloud-config
packages:
  - nginx
runcmd:
  - systemctl enable nginx
  - rm /var/www/html/*
  - &gt;
    echo "I'm Nginx @ $(dig -4 TXT +short o-o.myaddr.l.google.com @ns1.google.com)
    created $(date -u)" &gt;&gt; /var/www/html/index.html</code></pre>
<p>The file can be passed as <code>user_data</code> into the server the same way that
the <code>nginx</code> installation script has been before:</p>
<pre class="highlight"><code class="language-tf">resource "hcloud_server" "exercise_13" {
  ...
  user_data   = file("cloud_init.yml")
}</code></pre>
<h2 id="securing-ssh-login">Securing SSH login</h2>
<p>When observing the <code>journalctl</code> log we can observe connection attempts
over SSH to our machine. These are automated attacks from botnets and
are meant to find and take over vulnerable servers that are connected to
the internet. They try random username + password combinations in order
attempt logging in to random machines on the internet. Within minutes of
the start of the server multiple of those attempts have been observed:</p>
<pre class="highlight"><code class="language-txt"># journalctl -f
...
Jul 28 15:23:34 exercise-13 sshd[1785]: Invalid user admin from 103.114.246.37 port 31632
Jul 28 15:23:34 exercise-13 sshd[1785]: pam_unix(sshd:auth): check pass; user unknown
Jul 28 15:23:34 exercise-13 sshd[1785]: pam_unix(sshd:auth): authentication failure; logname= uid=0 euid=0 tty=ssh ruser= rhost=103.114.246.37
Jul 28 15:23:36 exercise-13 sshd[1787]: error: kex_exchange_identification: Connection closed by remote host
Jul 28 15:23:36 exercise-13 sshd[1787]: Connection closed by 196.251.114.29 port 51824
Jul 28 15:23:37 exercise-13 sshd[1785]: Failed password for invalid user admin from 103.114.246.37 port 31632 ssh2
Jul 28 15:23:37 exercise-13 sshd[1785]: Connection closed by invalid user admin 103.114.246.37 port 31632 [preauth]</code></pre>
<p>In order to mitigate these attacks disabling the password login via SSH
altogether will prevent these attackers from randomly guessing the
password. To disable the password login in <code>cloud-init</code> the option
<code>ssh_pwauth</code> can be set to <code>false</code>.</p>
<p>Additionally it is generally a bad idea to have a root user just lying
about. It is better to have an alternative user for administrative
purposes which can execute privileged commands using <code>sudo</code>. In
<code>cloud-init</code> this can be achieved by first disabling the root user with
the <code>disable_root</code> option and then create a new user in the <code>users</code>
section with a name and a <code>sudo</code> option that allows it to execute using
<code>sudo</code>. To be able to log in as the new user it needs to have an
authorized SSH key that is accepted as passwordless login and can be
specified using <code>ssh-authorized-keys</code>.</p>
<p>The following config disables the password login and root user and sets
up a new user named <code>devops</code> with root rights and <code>bash</code> as default
shell:</p>
<pre class="highlight"><code class="language-yml">ssh_pwauth: false
disable_root: true
users:
  - name: devops
    sudo: [ALL=(ALL) NOPASSWD:ALL]
    lock_passwd: true
    ssh-authorized-keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPZ4lA1SGICnXIgP1QUH8kLCzVFRQh3/hSlz+rBZtfUn
    shell: /bin/bash</code></pre>
<p>Attempting to login as <code>root</code> via ssh now fails. It doesn’t fail with
the message <code>Permission denied</code> for some reason, it rather says
<code>Please login as the user "NONE" rather than the user "root".</code> which
could be due to changes in <code>cloud-init</code>:</p>
<pre class="highlight"><code class="language-txt">$ ssh root@157.180.35.105
...
Please login as the user "NONE" rather than the user "root".</code></pre>
<p>The login to the newly created <code>devops</code> user is successful and the
acquisition of <code>root</code> works too:</p>
<pre class="highlight"><code class="language-txt">$ ssh devops@157.180.35.105
...
devops@exercise-13:~$ sudo su -
root@exercise-13:~#</code></pre>
<p>Investigating the <code>/etc/ssh/sshd_config</code> file shows, that <code>root</code> login
has not been disabled fully with these options:</p>
<pre class="highlight"><code class="language-txt">$ grep PermitRoot /etc/ssh/sshd_config
PermitRootLogin prohibit-password</code></pre>
<p>To fully disable root login this values has to be set to <code>no</code> which can
be done using <code>sed</code>:</p>
<pre class="highlight"><code class="language-yml">...
runcmd:
  - sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin no/' /etc/ssh/sshd_config
  ...</code></pre>
<h2 id="installing-fail2ban-plocate">Installing <code>fail2ban</code> &amp; <code>plocate</code></h2>
<p>To install <code>fail2ban</code> and <code>plocate</code> both packages simply have to be
added to the package list in the <code>cloud-init</code> file. But to make them
both work an some additional work is required.</p>
<p>In order for <code>plocate</code> to efficiently find files it needs to build a
file index database. The <code>plocate</code> package comes with a <code>updatedb</code>
command in order to do that. The command can simply be invoked in the
<code>runcmd</code> section of the <code>cloud-init</code> file.</p>
<p>For <code>fail2ban</code> there is a workaround necessary. The <code>python3-systemd</code>
package has to be installed additionally to make the <code>systemd</code> backend
available to <code>fail2ban</code>. On top of that the <code>jail.local</code> file has to be
created with some parameters for the <code>sshd</code> configuration of <code>fail2ban</code>.
Usually all default configuration lies in <code>/etc/fail2ban/jail.conf</code>.
Additional configuration can just be added to the
<code>/etc/fail2ban/jail.local</code> file which will then be merged with the
existing configuration in <code>jail.conf</code>. The following section has to be
added:</p>
<pre class="highlight"><code class="language-toml">[sshd]
backend = systemd
enabled = true</code></pre>
<p>This is done using the <code>echo</code> and <code>tee</code> commands in combination. After
that the <code>fail2ban</code> service has to be restarted using <code>sytemctl</code>.</p>
<p>All of the above steps are taken in the <code>cloud-init</code> file which now
looks like the following:</p>
<pre class="highlight"><code class="language-yml">#cloud-config
ssh_pwauth: false
disable_root: true
users:
  - name: devops
    sudo: [ALL=(ALL) NOPASSWD:ALL]
    lock_passwd: true
    ssh-authorized-keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPZ4lA1SGICnXIgP1QUH8kLCzVFRQh3/hSlz+rBZtfUn
    shell: /bin/bash
package_reboot_if_required: true
package_update: true
package_upgrade: true
packages:
  - nginx
  - fail2ban
  - python3-systemd
  - plocate
runcmd:
  - sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin no/' /etc/ssh/sshd_config
  # Fail2ban workaround
  - echo "[sshd]\nbackend = systemd\nenabled = true" | tee /etc/fail2ban/jail.local
  - systemctl restart fail2ban
  # Update plocate database
  - updatedb
  # Nginx
  - systemctl enable nginx
  - rm /var/www/html/*
  - &gt;
    echo "I'm Nginx @ $(dig -4 TXT +short o-o.myaddr.l.google.com @ns1.google.com)
    created $(date -u)" &gt;&gt; /var/www/html/index.html</code></pre>
<p>With that the login, sudo commands, <code>fail2ban</code> and <code>plocate</code> work like
intended:</p>
<pre class="highlight"><code class="language-txt">$ ssh devops@157.180.35.105
...
devops@exercise-13:~$ plocate ssh_host
/etc/ssh/ssh_host_dsa_key
/etc/ssh/ssh_host_dsa_key.pub
...
devops@exercise-13:~$ sudo apt update
...
All packages are up to date.
devops@exercise-13:~$ sudo systemctl status fail2ban
● fail2ban.service - Fail2Ban Service
      Loaded: loaded (/lib/systemd/system/fail2ban.service; enabled; preset: enabled)
      Active: active (running) since Mon 2025-07-28 16:36:22 UTC; 19min ago
...</code></pre>
<h2 id="firewall-attachment-issues">Firewall Attachment Issues</h2>
<p>At some point during the project Hetzner had issues with attaching, and especially removing firewalls from servers using the <code>firewall_ids</code> attribute in the server's definitions.
There was a technical issue that made firewall detachment take way longer than expected, resulting in firewalls being still assigned to a server resource while the server itself was already destructed at that point.
The firewalls couldn't be deleted anymore since they were still attached to a resource when in fact the resource was not existsing anymore leaving them orphaned.</p>
<p>To stop this issue from occuring a firewall attachment has explicitly been specified to connect the firewall to the server.
The Terraform <code>lifecycle</code> argument can then be used to force Terraform to replace the whole attachment on change of one of the resources referenced, stopping the implicit changes and attachments that were the issue before:</p>
<pre class="highlight"><code class="language-tf">resource "hcloud_firewall_attachment" "exercise_fw_attachment" {
  firewall_id = hcloud_firewall.fw_exercise_13.id
  server_ids  = [hcloud_server.exercise_13.id]
  lifecycle {
    replace_triggered_by = [ hcloud_server.exercise_13, hcloud_firewall.fw_exercise_13 ]
  }
}</code></pre>
<p>In the following exercises this method has been used throughout to mitigate this problem and prevent lots of orphaned firewalls in the group.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../exercise12/" class="btn btn-neutral float-left" title="Exercise 12"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../exercise14/" class="btn btn-neutral float-right" title="Exercise 14">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../exercise12/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../exercise14/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
