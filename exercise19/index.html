<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Exercise 19 - Software Defined Infrastructure Group 2</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Exercise 19";
        var mkdocs_page_input_path = "exercise19.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Software Defined Infrastructure Group 2
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Manual Server Management</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise01/">Exercise 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise02/">Exercise 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise03/">Exercise 3</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise04/">Exercise 4</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise05/">Exercise 5</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise06/">Exercise 6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise07/">Exercise 7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise08/">Exercise 8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise09/">Exercise 9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise10/">Exercise 10</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cloud Provider</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../exercise11/">Exercise 11</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise12/">Exercise 12</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise13/">Exercise 13</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise14/">Exercise 14</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise15/">Exercise 15</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise16/">Exercise 16</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise17/">Exercise 17</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise18/">Exercise 18</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Exercise 19</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise20/">Exercise 20</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise21/">Exercise 21</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise22/">Exercise 22</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise23/">Exercise 23</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise24/">Exercise 24</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise25/">Exercise 25</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise26/">Exercise 26</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Software Defined Infrastructure Group 2</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Cloud Provider</li>
      <li class="breadcrumb-item active">Exercise 19</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="exercise-19-creating-dns-records">Exercise 19: Creating DNS records</h1>
<p>Currently the DNS configuration has only been done manually before in <a href="../exercise18/">Exercise 18</a>.
If the Terraform configuration is destroyed and then applied the IP may change making all the DNS entries invalid.
It is much better to automatically create and update the DNS entries using Terraform.
To do that it is ensured that there are no leftover DNS entries in the <code>ns1.hdm-stuttgart.cloud</code> nameserver:</p>
<pre class="highlight"><code class="language-txt">$ dig +noall +answer @ns1.hdm-stuttgart.cloud -y $HMAC -t AXFR g2.sdi.hdm-stuttgart.cloud
g2.sdi.hdm-stuttgart.cloud. 600 IN      SOA     ns1.hdm-stuttgart.cloud. goik\@hdm-stuttgart.de. 20 604800 86400 2419200 604800
g2.sdi.hdm-stuttgart.cloud. 600 IN      NS      ns1.hdm-stuttgart.cloud.
g2.sdi.hdm-stuttgart.cloud. 600 IN      SOA     ns1.hdm-stuttgart.cloud. goik\@hdm-stuttgart.de. 20 604800 86400 2419200 604800</code></pre>
<p>To create different DNS records automatically in Terraform the <code>dns</code> provider can be used.
It has to be configured with the address and secret key of the server to be able to create, update and delete DNS records.
To hold the secret key, a variable has been created that will be injected using a non-versioned <code>secrets.auto.tfvars</code> file:</p>
<pre class="highlight"><code class="language-tf">variable "dns_secret_key" {
  description = "Secret Key for the DNS nameserver"
  type        = string
  sensitive   = true
}

provider "dns" {
  update {
    server        = "ns1.hdm-stuttgart.cloud"
    key_name      = "g2.key."
    key_algorithm = "hmac-sha512"
    key_secret    = var.dns_secret_key
  }
}</code></pre>
<p>In this exercise two types of DNS records should be created: <code>A</code> and <code>CNAME</code>.
<code>A</code> records have been discussed in <a href="../exercise18/">Exercise 18</a> before.
<code>CNAME</code> records are alias records: They point from one domain name to another domain name.
The domain they are aliasing will then have to be looked up, following the chain until an IP address is found.
The following records are created using Terraform:</p>
<ul>
<li>A base <code>A</code> record with the domain name <code>g2.sdi.hdm-stuttgart.cloud</code> pointing to the server IP</li>
<li>A main <code>A</code> record with the name of the server appended to the domain (e.g. <code>workhorse.g2.sdi.hdm-stuttgart.cloud</code>) also pointing to the server IP</li>
<li>A set of <code>CNAME</code> aliases, all pointing to the main <code>A</code> record (e.g. <code>mail.g2.sdi.hdm-stuttgart.cloud</code> and  <code>www.g2.sdi.hdm-stuttgart.cloud</code>)</li>
</ul>
<p>To keep these records as modular as possible all the domains are specified using variables.
The base domain, a main server name as well as a set of alias names (entries are automatically unique), which is validated to not contain the main server name:</p>
<pre class="highlight"><code class="language-tf">variable "dns_server_domain" {
  description = "The base domain of the server"
  type        = string
  default     = "g2.sdi.hdm-stuttgart.cloud"
}

variable "dns_server_name" {
  description = "The name of the server"
  type        = string
}

variable "dns_server_aliases" {
  description = "Alias names of the server"
  type        = set(string)
  default     = []
  validation {
    condition     = !contains(var.dns_server_aliases, var.dns_server_name)
    error_message = "Alias may not shadow the main name"
  }
}</code></pre>
<p>These variables are then used to create the above mentioned set of DNS records.
The <code>A</code> records are straightforward.
They just take in the domain and the IP address the record is supposed to be pointing to.
The <code>CNAME</code> records take in the domain they are aliasing instead of the IP but due to there being a variable amount of aliases the <code>for_each</code> argument is used to create a Terraform loop which executes the resource once for every alias specified.
The implicit attribute <code>each.key</code> is then used to get the individual name of each alias.</p>
<pre class="highlight"><code class="language-tf">resource "dns_a_record_set" "exercise_dns_base_record" {
  zone      = "${var.dns_server_domain}."
  addresses = [hcloud_server.exercise_19.ipv4_address]
  ttl       = 10
}

resource "dns_a_record_set" "exercise_dns_name_record" {
  zone      = "${var.dns_server_domain}."
  name      = var.dns_server_name
  addresses = [hcloud_server.exercise_19.ipv4_address]
  ttl       = 10
}

resource "dns_cname_record" "exercise_dns_alias_records" {
  for_each = toset(var.dns_server_aliases)
  zone     = "${var.dns_server_domain}."
  name     = each.key
  cname    = "${var.dns_server_name}.${var.dns_server_domain}."
  ttl      = 10
}</code></pre>
<p>After running terraform apply now the DNS entries can be confirmed using <code>dig</code>.
They will also be removed again when running <code>terraform destroy</code>:</p>
<pre class="highlight"><code class="language-txt">$ dig +noall +answer @ns1.hdm-stuttgart.cloud -y $HMAC -t AXFR g2.sdi.hdm-stuttgart.cloud
g2.sdi.hdm-stuttgart.cloud. 600 IN      SOA     ns1.hdm-stuttgart.cloud. goik\@hdm-stuttgart.de. 16 604800 86400 2419200 604800
g2.sdi.hdm-stuttgart.cloud. 10  IN      A       37.27.219.19
g2.sdi.hdm-stuttgart.cloud. 600 IN      NS      ns1.hdm-stuttgart.cloud.
mail.g2.sdi.hdm-stuttgart.cloud. 10 IN  CNAME   workhorse.g2.sdi.hdm-stuttgart.cloud.
workhorse.g2.sdi.hdm-stuttgart.cloud. 10 IN A   37.27.219.19
www.g2.sdi.hdm-stuttgart.cloud. 10 IN   CNAME   workhorse.g2.sdi.hdm-stuttgart.cloud.
g2.sdi.hdm-stuttgart.cloud. 600 IN      SOA     ns1.hdm-stuttgart.cloud. goik\@hdm-stuttgart.de. 16 604800 86400 2419200 604800

$ terraform destroy
...

$ dig +noall +answer @ns1.hdm-stuttgart.cloud -y $HMAC -t AXFR g2.sdi.hdm-stuttgart.cloud
g2.sdi.hdm-stuttgart.cloud. 600 IN      SOA     ns1.hdm-stuttgart.cloud. goik\@hdm-stuttgart.de. 20 604800 86400 2419200 604800
g2.sdi.hdm-stuttgart.cloud. 600 IN      NS      ns1.hdm-stuttgart.cloud.
g2.sdi.hdm-stuttgart.cloud. 600 IN      SOA     ns1.hdm-stuttgart.cloud. goik\@hdm-stuttgart.de. 20 604800 86400 2419200 604800</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../exercise18/" class="btn btn-neutral float-left" title="Exercise 18"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../exercise20/" class="btn btn-neutral float-right" title="Exercise 20">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../exercise18/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../exercise20/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
