<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Exercise 16 - Software Defined Infrastructure Group 2</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Exercise 16";
        var mkdocs_page_input_path = "exercise16.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Software Defined Infrastructure Group 2
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Manual Server Management</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise01/">Exercise 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise02/">Exercise 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise03/">Exercise 3</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise04/">Exercise 4</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise05/">Exercise 5</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise06/">Exercise 6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise07/">Exercise 7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise08/">Exercise 8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise09/">Exercise 9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise10/">Exercise 10</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cloud Provider</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../exercise11/">Exercise 11</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise12/">Exercise 12</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise13/">Exercise 13</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise14/">Exercise 14</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise15/">Exercise 15</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Exercise 16</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise17/">Exercise 17</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise18/">Exercise 18</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise19/">Exercise 19</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise20/">Exercise 20</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise21/">Exercise 21</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise22/">Exercise 22</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise23/">Exercise 23</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise24/">Exercise 24</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise25/">Exercise 25</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise26/">Exercise 26</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Software Defined Infrastructure Group 2</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Cloud Provider</li>
      <li class="breadcrumb-item active">Exercise 16</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="exercise-16-mount-points-name-specification">Exercise 16: Mount point’s name specification</h1>
<p>Instead of handling the mount of the disks manually and using
automounted volumes the mounting can also be done manually. This results
in much more control over the mounting process than when using
automount.</p>
<p>The process is largely the same as in the previous exercise but done
automatically. To make the architecture configuration more customizable
two new variables are introduced: <code>location</code> and <code>volume_mount</code>.</p>
<pre class="highlight"><code class="language-tf">variable "volume_mount" {
  description = "Mounting point of the volume in the root file system"
  type        = string
  default     = "volume01"
}

variable "location" {
  description = "Hetzner datacenter location to create the main resources in"
  type        = string
  default     = "hel1"
  validation {
    condition     = contains(["fsn1", "nbg1", "hel1", "ash", "hil", "sin"], var.location)
    error_message = "The location must be a valid datacenter"
  }
}</code></pre>
<p><code>location</code> is used to control the datacenter of both the server and the
volume. Without specifying a common datacenter the volume and the server
may be created in datacenters to Hetzners discretion. They will want the
created architecture to be always balanced so if one datacenter has a
high capacity of volumes, new volumes will more likely be created there
if no explicit location is specified. This problem was not occurring
when automounting was enabled since the volume was directly attached to
a server. To ensure valid values are used a custom validation is added
to the <code>location</code> variable to ensure the value specified is one of
<a href="https://docs.hetzner.com/cloud/general/locations/#what-locations-are-there">Hetzner’s
datacenters</a>.</p>
<p>The <code>volume_mount</code> variable is used to specify the mounting path of the
attached volume in the root file system. It is used by the <code>cloud-init</code>
script to create and mount at the correct location.</p>
<p>Since the volume creation is now decoupled from the server creation the
architecture has to be modified:</p>
<pre class="highlight"><code class="language-tf">resource "hcloud_volume" "volume_exercise_16" {
  name     = "volume-exercise-16"
  size     = 10
  location = var.location
  format   = "xfs"
}

resource "hcloud_server" "exercise_16" {
  name        = "exercise-16"
  image       = "debian-12"
  server_type = "cpx11"
  location    = var.location
  user_data   = local_file.cloud_init.content
}

resource "hcloud_volume_attachment" "exercise_volume_attachment" {
  volume_id = hcloud_volume.volume_exercise_16.id
  server_id = hcloud_server.exercise_16.id
  automount = false
  lifecycle {
    replace_triggered_by = [hcloud_server.exercise_16, hcloud_volume.volume_exercise_16]
  }
}</code></pre>
<p>The <code>cloud-init</code> script is now responsible for mounting the volume to
the correct location on the server. For that the entry in <code>/etc/fstab</code>
has to be created and then the mount has to be triggered via <code>mount -a</code>:</p>
<pre class="highlight"><code class="language-yml">runcmd:
  ...
  - mkdir /${volume_mount}
  - echo ${volume_device} /${volume_mount} xfs auto,rw,defaults 0 2 &gt;&gt; /etc/fstab
  - systemctl daemon-reload
  - mount -a
  ...</code></pre>
<p>When trying this out the resulting file system was usually not mounted.
This could be because the <code>mount -a</code> command is executed too early,
resulting in some other processes to still be busy with the changes made
to the mounting system. It may also be possible that the volume
attachment used to attach the volume to the server takes longer than
expected. It is being created after the creation of both server and
volume which would make it a likely failure point.</p>
<p>To resolve this issue the call to <code>mount -a</code> has been moved to the end
of the <code>runcmd</code> section after a <code>sleep</code>, giving the system enough time
to settle before mounting the volume:</p>
<pre class="highlight"><code class="language-yml">runcmd:
  ...
  - mkdir /${volume_mount}
  - echo ${volume_device} /${volume_mount} xfs auto,rw,defaults 0 2 &gt;&gt; /etc/fstab
  - systemctl daemon-reload
  ...
  - sleep 5
  - mount -a</code></pre>
<p>Now the volume can correctly be found in the file system after creation
of the server:</p>
<pre class="highlight"><code class="language-txt">$ ./bin/ssh.sh
...
devops@exercise-16:~$ df -h
...
/dev/sdb         10G  104M  9.9G   2% /disk</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../exercise15/" class="btn btn-neutral float-left" title="Exercise 15"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../exercise17/" class="btn btn-neutral float-right" title="Exercise 17">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../exercise15/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../exercise17/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
