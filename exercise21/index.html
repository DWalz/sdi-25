<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Exercise 21 - Software Defined Infrastructure Group 2</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Exercise 21";
        var mkdocs_page_input_path = "exercise21.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Software Defined Infrastructure Group 2
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Manual Server Management</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise01/">Exercise 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise02/">Exercise 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise03/">Exercise 3</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise04/">Exercise 4</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise05/">Exercise 5</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise06/">Exercise 6</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise07/">Exercise 7</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise08/">Exercise 8</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise09/">Exercise 9</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise10/">Exercise 10</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cloud Provider</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../exercise11/">Exercise 11</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise12/">Exercise 12</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise13/">Exercise 13</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise14/">Exercise 14</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise15/">Exercise 15</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise16/">Exercise 16</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise17/">Exercise 17</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise18/">Exercise 18</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise19/">Exercise 19</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise20/">Exercise 20</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Exercise 21</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#export-the-dns-module">Export the DNS module</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#create-multiple-servers">Create Multiple Servers</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#problems-with-the-approach">Problems with the Approach</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#the-working-dns-loop">The Working DNS Loop</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise22/">Exercise 22</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise23/">Exercise 23</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise24/">Exercise 24</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise25/">Exercise 25</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exercise26/">Exercise 26</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Software Defined Infrastructure Group 2</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Cloud Provider</li>
      <li class="breadcrumb-item active">Exercise 21</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="exercise-21-creating-a-fixed-number-of-servers">Exercise 21: Creating a fixed number of servers</h1>
<blockquote>
<p>This exercise is not used as base for the following exercises since it modifies and complicates some main aspects of the configuration.</p>
</blockquote>
<p>To be able to create a fixed number of servers, a lot of Terraform loops have to be used.
Every resource, that belongs to one server will have to be looped and all the references between the resources have to be adjusted.</p>
<h2 id="export-the-dns-module">Export the DNS module</h2>
<p>To prepare the process, the DNS registration process has been extracted into its own module: <code>custom_dns</code>.
It takes in the arguments given before (<code>zone</code>, <code>base_name</code>, <code>alias</code> and <code>server_ip</code>) and builds the DNS records everytime it is called.
This allows us to call the module in a loop for every server, drastically reducing the need for more loops.
It is important to note that the module doesn't need the provider specification explicitly.
As long as the provider is initialized in the root module it will be shared amongst called modules.
It is even possible to specify separate provider initalizations and pass them individually to called modules.</p>
<p>The created DNS module looks like the following (without variable declarations for brevity):</p>
<pre class="highlight"><code class="language-tf">terraform {
  required_providers {
    dns = {
      source = "hashicorp/dns"
    }
  }
}

resource "dns_a_record_set" "exercise_dns_name_record" {
  zone      = "${var.zone}."
  name      = var.main_name
  addresses = [var.server_ip]
  ttl       = 10
}

resource "dns_cname_record" "exercise_dns_alias_records" {
  for_each = toset(var.alias)
  zone     = "${var.zone}."
  name     = each.key
  cname    = "${var.main_name}.${var.zone}."
  ttl      = 10
}</code></pre>
<h2 id="create-multiple-servers">Create Multiple Servers</h2>
<p>With that we can begin to create multiple servers.
This is done using the Terraform <code>count</code> attribute which can be used to specify the number of that resource that should be created.
If it is specified the <code>count.index</code> variable becomes implicitly available, storing the index of the current resource instance.
This number can then be used by other referencing resources to select the right resource instance from the set:</p>
<pre class="highlight"><code class="language-tf">resource "tls_private_key" "server_ssh_key" {
  count     = var.server_count
  algorithm = "ED25519"
}

resource "local_file" "cloud_init" {
  count    = var.server_count
  filename = "./server-${count.index}/gen/cloud_init.yml"
  content = templatefile("./template/cloud_init.yml", {
    default_user     = var.server_username
    local_ssh_public = file("~/.ssh/id_ed25519.pub")
    ssh_private      = tls_private_key.server_ssh_key[count.index].private_key_openssh
    ssh_public       = tls_private_key.server_ssh_key[count.index].public_key_openssh
    volume_mount     = var.volume_mount
    volume_device    = hcloud_volume.volume_exercise_20[count.index].linux_device
  })
}</code></pre>
<p>Another example is the creation of the main server and the calling of the modules:</p>
<pre class="highlight"><code class="language-tf">resource "hcloud_server" "exercise_20" {
  count       = var.server_count
  name        = "exercise-20-${count.index}"
  image       = "debian-12"
  server_type = "cpx11"
  location    = var.location
  user_data   = local_file.cloud_init[count.index].content
}

resource "hcloud_firewall_attachment" "exercise_fw_attachment" {
  count       = var.server_count
  firewall_id = hcloud_firewall.fw_exercise_20.id
  server_ids  = [hcloud_server.exercise_20[count.index].id]
  lifecycle {
    replace_triggered_by = [hcloud_server.exercise_20[count.index], hcloud_firewall.fw_exercise_20]
  }
}

module "ssh_wrapper" {
  count             = var.server_count
  source            = "../modules/ssh_wrapper"
  server_hostname   = "${var.dns_server_name}-${count.index}.${var.dns_server_domain}"
  server_username   = var.server_username
  server_public_key = tls_private_key.server_ssh_key[count.index].public_key_openssh
  output_dir        = "${path.module}/server-${count.index}"
}

module "custom_dns" {
  count     = var.server_count
  source    = "../modules/custom_dns"
  zone      = "g2.sdi.hdm-stuttgart.cloud"
  main_name = "${var.dns_server_name}-${count.index}"
  server_ip = hcloud_server.exercise_20[count.index].ipv4_address
  alias = [
    for alias in var.dns_server_aliases :
    "${alias}-${count.index}"
  ]
}</code></pre>
<p>The <code>ssh_wrapper</code> module will deposit it's files based on the specified output file: <code>server-0/bin</code>, ... for the first server and <code>server-1/bin</code>, ... for the second one and so on.</p>
<p>As is visible in the <code>firewall_attachment</code> resource, the firewall does not need to be created multiple times.
It can simply be created once and be applied to multiple servers at the same time.</p>
<h3 id="problems-with-the-approach">Problems with the Approach</h3>
<p>Note that the resources are not inherently connected: A mismatch in arity of the resources would lead to reference issues.
Since the variables are predefined the <code>terraform plan</code>/<code>terraform apply</code> commands would be able to derive the wrong references, but there is still a number of points of failure.
One has to be extremely careful in which resources need to be looped and which doesnt - forgetting one can "fail" silently and only create issues later or don't even be noticed at all.
If it was forgotten to duplicate the SSH keypair resource and the references, every server would have the same SSH private key and fingerprint - Terraform wouldn't notice this.</p>
<p>To better encapsulate this behavior it would be sensible to extract the actual resources into modules like the DNS module.
The module could then output values like the created server, volume and so on to allow access from the root module but this is beyond the scope of this exercise.</p>
<h2 id="the-working-dns-loop">The Working DNS Loop</h2>
<p>Due to the loop call of the DNS module we can observe multiple DNS entries for every server:
One <code>A</code> record for each server pointing to it's IP and one <code>CNAME</code> record for every alias pointing to the main server.
Because there are multiple server now the base server has been removed as a main <code>A</code> record since there isn't only one single server we could point <code>g2.sdi.hdm-stuttgart.cloud</code> to.</p>
<p>Accessing the DNS records reveals that there is one record set for each server created:</p>
<pre class="highlight"><code class="language-txt">$ dig +noall +answer @ns1.hdm-stuttgart.cloud -y $HMAC -t AXFR g2.sdi.hdm-stuttgart.cloud
g2.sdi.hdm-stuttgart.cloud. 600 IN      SOA     ns1.hdm-stuttgart.cloud. goik\@hdm-stuttgart.de. 40 604800 86400 2419200 604800
g2.sdi.hdm-stuttgart.cloud. 600 IN      NS      ns1.hdm-stuttgart.cloud.
mail-0.g2.sdi.hdm-stuttgart.cloud. 10 IN CNAME  work-0.g2.sdi.hdm-stuttgart.cloud.
mail-1.g2.sdi.hdm-stuttgart.cloud. 10 IN CNAME  work-1.g2.sdi.hdm-stuttgart.cloud.
work-0.g2.sdi.hdm-stuttgart.cloud. 10 IN A      157.180.35.105
work-1.g2.sdi.hdm-stuttgart.cloud. 10 IN A      37.27.219.19
www-0.g2.sdi.hdm-stuttgart.cloud. 10 IN CNAME   work-0.g2.sdi.hdm-stuttgart.cloud.
www-1.g2.sdi.hdm-stuttgart.cloud. 10 IN CNAME   work-1.g2.sdi.hdm-stuttgart.cloud.
g2.sdi.hdm-stuttgart.cloud. 600 IN      SOA     ns1.hdm-stuttgart.cloud. goik\@hdm-stuttgart.de. 40 604800 86400 2419200 604800</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../exercise20/" class="btn btn-neutral float-left" title="Exercise 20"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../exercise22/" class="btn btn-neutral float-right" title="Exercise 22">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../exercise20/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../exercise22/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
